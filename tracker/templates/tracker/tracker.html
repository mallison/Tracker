{% extends "tracker/base.html" %}
{% block content %}
{% with chunk.task as task %}
    <h1>Tracker: {{ task.project.name }} &rarr; {{ task.name }} &rarr; chunk {{ chunk.ordinal }}</h1>
{% endwith %}
<table>
    <tr>
        <td valign="top">
            <form method="post" action=".">
                <!-- TODO refresh timesince dynamically -->
                <p>Task time: {{ chunk.task.cumulative_time }} minutes</p>
                <p>This chunk: <span id="chunk_time">{{ chunk.start|timesince }}</span> minutes</p>
                {{ notes_form.as_p }}
                <input type="submit" name="save" value="save chunk"> |
                <input type="submit" name="new" value="new chunk"> |
                <input type="submit" name="stop" value="stop task"> |
                <input type="submit" name="finish" value="finish task">
                {% if task_form.errors %}{{ task_form.errors }}{% endif %}
                <p>switch to: {% for field in task_form %}{{ field.label_tag }} {{ field }} {% endfor %}<input type="submit" name="switch" value="go"></p>
            </form>
        </td>
        <td valign="top">
            {% for chunk in chunks %}
                <dl>
                    <dt>{{ chunk.task.project.name }} &rarr; {{ chunk.task.name }} &rarr; {{ chunk.ordinal }}: {{ chunk.duration }} minutes</dt>
                    <dl><pre>{{ chunk.notes }}</pre></dl>
                </dl>
            {% endfor %}
        </td>
    </tr>
</table>
<script>
$(function () {
    var chunk_time = $('#chunk_time');
    var start_time = new Date;
    var one_minute = 60000  // milliseconds

    var update_chunk_time = function () {
        var now = new Date;
        var elapsed = Math.round((now - start_time) / one_minute);
        chunk_time.text(elapsed);
    }

    var init = function () {
        update_chunk_time();
        setInterval(update_chunk_time, one_minute);
    }();
})
</script>
{% endblock %}
